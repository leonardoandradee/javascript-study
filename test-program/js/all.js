"use strict";var form=document.getElementById("formAluno"),resultado=document.getElementById("resultado"),btnGerar=document.getElementById("gerarNotas"),btnCadastrar=document.getElementById("btnCadastrar"),containerNotas=document.getElementById("notasContainer"),filtroStatus=document.getElementById("filtroStatus"),ordenarPor=document.getElementById("ordenarPor"),filtroNome=document.getElementById("filtroNome"),btnLimparLista=document.getElementById("btnLimparLista"),containerFiltroStatus=document.getElementById("containerFiltroStatus"),containerOrdenarPor=document.getElementById("containerOrdenarPor"),containerFiltroNome=document.getElementById("containerFiltroNome"),graficoContainer=document.getElementById("graficoDesempenhoContainer"),btnExportarCSV=document.getElementById("btnExportarCSV"),btnExportarJSON=document.getElementById("btnExportarJSON"),alunos=(filtroStatus.addEventListener("change",exibirRelatorio),ordenarPor.addEventListener("change",exibirRelatorio),filtroNome.addEventListener("input",exibirRelatorio),btnExportarCSV.addEventListener("click",exportarCSV),btnExportarJSON.addEventListener("click",exportarJSON),btnLimparLista.addEventListener("click",function(){confirm("Tem certeza que deseja limpar toda a lista de alunos?")&&(alunos=[],salvarAlunosNoLocalStorage(),exibirRelatorio())}),[]);function salvarAlunosNoLocalStorage(){localStorage.setItem("alunos",JSON.stringify(alunos)),controlarVisibilidadeFiltros()}function carregarAlunosDoLocalStorage(){var e=localStorage.getItem("alunos");alunos=e?JSON.parse(e):[],controlarVisibilidadeFiltros(),exibirRelatorio()}function validarNota(e){var e=e.toString().replace(",","."),t=Number(e);return!(isNaN(t)||t<0||10<t||!Number.isInteger(t)&&!(2===(t=e.split(".")).length&&t[1].length<=2))}function esconderBotaoCadastrar(){btnCadastrar.disabled=!0,btnCadastrar.style.display="none"}function mostrarBotaoCadastrar(){btnCadastrar.disabled=!1,btnCadastrar.style.display="inline-block"}function controlarVisibilidadeFiltros(){var e=0<alunos.length;containerFiltroStatus.style.display=e?"inline-block":"none",containerOrdenarPor.style.display=e?"inline-block":"none",containerFiltroNome.style.display=e?"inline-block":"none",btnLimparLista.style.display=e?"inline-block":"none"}function encontrarIndiceMaiorMedia(){if(0===alunos.length)return-1;for(var e=0,t=alunos[0].media,a=1;a<alunos.length;a++)alunos[a].media>t&&(t=alunos[a].media,e=a);return e}function encontrarIndiceMaiorMediaFiltrado(e){if(0===e.length)return-1;for(var t=0,a=e[0].media,o=1;o<e.length;o++)e[o].media>a&&(a=e[o].media,t=o);return t}esconderBotaoCadastrar(),btnGerar.addEventListener("click",function(){containerNotas.innerHTML="",esconderBotaoCadastrar();var e=parseInt(document.getElementById("quantidade").value);if(isNaN(e)||e<=0)alert("Informe uma quantidade válida de bimestres.");else{var t=document.createElement("div");t.style.display="grid",t.style.gridTemplateColumns="1fr 1fr",t.style.gap="1rem";for(var a=1;a<=e;a++){var o=document.createElement("label"),n=(o.setAttribute("for","nota".concat(a)),o.textContent="Nota do ".concat(a,"º Bimestre:"),document.createElement("input")),r=(n.type="number",n.name="nota".concat(a),n.id="nota".concat(a),n.min=0,n.max=10,n.step=.01,n.required=!0,document.createElement("div"));r.classList.add("nota-wrapper"),r.style.display="flex",r.style.flexDirection="column",r.appendChild(o),r.appendChild(n),t.appendChild(r)}containerNotas.appendChild(t),mostrarBotaoCadastrar()}}),form.addEventListener("submit",function(e){e.preventDefault();var e=document.getElementById("nome").value.trim(),t=parseInt(document.getElementById("quantidade").value);if(isNaN(t)||t<=0)alert("Você deve gerar os campos de nota primeiro.");else{for(var a=0,o=[],n=1;n<=t;n++){var r=document.getElementById("nota".concat(n)).value;if(!validarNota(r))return void alert("Nota ".concat(n," inválida. Informe um número entre 0 e 10, com até 2 casas decimais."));r=Number(r.toString().replace(",","."));o.push(r),a+=r}var i=a/t,l="",l=6<=i?"Aprovado":4<=i?"Recuperação":"Reprovado";alunos.push({nome:e,notas:o,media:i,status:l}),salvarAlunosNoLocalStorage(),exibirRelatorio(),form.reset(),containerNotas.innerHTML="",esconderBotaoCadastrar()}}),resultado.innerHTML="";var chartInstance=null;function atualizarGrafico(e){var t=document.getElementById("graficoDesempenho").getContext("2d"),a=(chartInstance&&chartInstance.destroy(),e.map(function(e){return e.nome})),e=e.map(function(e){return Number(e.media.toFixed(2))});chartInstance=new Chart(t,{type:"bar",data:{labels:a,datasets:[{label:"Média do Aluno",data:e,backgroundColor:"rgba(0, 113, 188, 1)",borderColor:"rgba(0, 113, 188, 1)",borderWidth:1}]},options:{scales:{y:{beginAtZero:!0,max:10}},plugins:{legend:{display:!0},tooltip:{enabled:!0}}}})}function exibirRelatorio(){var t,e,a,o,r,i;0===alunos.length?(resultado.style.display="none",resultado.innerHTML="",graficoContainer.style.display="none",controlarVisibilidadeFiltros()):(graficoContainer.style.display="block",e=alunos.slice(),"todos"!==(o=filtroStatus.value)&&(t={aprovado:"Aprovado",recuperacao:"Recuperação",reprovado:"Reprovado"}[o],e=e.filter(function(e){return e.status===t})),""!==(a=filtroNome.value.toLowerCase().trim())&&(e=e.filter(function(e){return e.nome.toLowerCase().includes(a)})),o=ordenarPor.value,"nome"===o?e.sort(function(e,t){return e.nome.localeCompare(t.nome)}):"media"===o&&e.sort(function(e,t){return t.media-e.media}),r=encontrarIndiceMaiorMediaFiltrado(e),resultado.style.display="block",i="<h2 style='text-align:center;'>Relatório Geral</h2>",i+='<div class="relatorio-grid">',e.forEach(function(e,t){var a="",a="Aprovado"===e.status?"status-aprovado":"Recuperação"===e.status?"status-recuperacao":"status-reprovado",o=alunos.indexOf(e),n=t===r?" ⭐":"";i+='\n    <div class="aluno-relatorio '.concat(t===r?"aluno-destaque":"",'">\n        <p><strong>Aluno ').concat(t+1,": ").concat(e.nome).concat(n,"</strong></p>\n        <p>Notas: ").concat(e.notas.map(function(e){return e.toFixed(2).replace(".",",")}).join(", "),"</p>\n        <p>Média: ").concat(e.media.toFixed(2).replace(".",","),'</p>\n        <p>Status: <strong class="').concat(a,'">').concat(e.status,'</strong></p>\n        <div class="botoes-acao">\n          <button onclick="editarAluno(').concat(o,')">Editar</button>\n          <button onclick="excluirAluno(').concat(o,')">Excluir</button>\n        </div>\n    </div>\n  ')}),i+="</div>",resultado.innerHTML=i,atualizarGrafico(e))}function excluirAluno(e){confirm('Tem certeza que deseja excluir o aluno "'.concat(alunos[e].nome,'"?'))&&(alunos.splice(e,1),salvarAlunosNoLocalStorage(),exibirRelatorio())}function editarAluno(e){var t=alunos[e];document.getElementById("nome").value=t.nome,document.getElementById("quantidade").value=t.notas.length,btnGerar.click(),setTimeout(function(){t.notas.forEach(function(e,t){document.getElementById("nota".concat(t+1)).value=e}),alunos.splice(e,1),salvarAlunosNoLocalStorage(),exibirRelatorio(),mostrarBotaoCadastrar()},100)}function exportarCSV(){var a,e,t;function o(e){return e=(e="string"!=typeof e?String(e):e).replace(/"/g,'""'),'"'.concat(e,'"')}0===alunos.length?alert("Não há alunos para exportar."):(a="Nome;Notas;Média;Status\n",alunos.forEach(function(e){var t=e.notas.map(function(e){return e.toFixed(2).replace(".",",")}).join(", "),t=o(e.nome)+";"+o(t)+";"+o(e.media.toFixed(2).replace(".",","))+";"+o(e.status)+"\n";a+=t}),e=new Blob(["\ufeff"+a],{type:"text/csv;charset=utf-8;"}),e=URL.createObjectURL(e),(t=document.createElement("a")).href=e,t.setAttribute("download","alunos_boletim.csv"),document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(e))}function exportarJSON(){var e,t;0===alunos.length?alert("Não há alunos para exportar."):(e=JSON.stringify(alunos,null,2),e=new Blob([e],{type:"application/json"}),e=URL.createObjectURL(e),(t=document.createElement("a")).href=e,t.setAttribute("download","alunos_boletim.json"),document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(e))}window.onload=function(){carregarAlunosDoLocalStorage()};